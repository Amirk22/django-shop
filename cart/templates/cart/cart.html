{% extends 'base.html' %}
{% load custom_filters %}
{% load static %}
{% load thumbnail %}

{% block title %}سبد خرید{% endblock %}

{% block content %}
<head>
<style>
    body {
        background: #f5f5f5;
        margin: 0;
        direction: rtl;
    }
    h2 {
        text-align: center;
        color: #333;
    }
    table {
        width: 100%;
        max-width: 700px;
        margin: 20px auto;
        border-collapse: collapse;
        background: #fff;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    th, td {
        padding: 12px;
        text-align: center;
        vertical-align: middle;
    }
    th {
        background: #222;
        color: #fff;
    }
    tr:nth-child(even) {
        background: #fafafa;
    }

    .qty-wrapper {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 8px;
    }
    .qty-wrapper form {
        margin: 0;
    }
    .qty-btn {
        padding: 5px 10px;
        cursor: pointer;
        font-weight: bold;
        background: #007bff;
        color: #fff;
        border: none;
        border-radius: 4px;
        transition: 0.2s;
    }
    .qty-btn:hover {
        background: #0056b3;
    }
    .qty-btn:disabled {
        background: #aaa;
        cursor: not-allowed;
    }
    .qty-input {
        width: 50px;
        text-align: center;
        border: 1px solid #ccc;
        border-radius: 4px;
        height: 30px;
        font-size: 14px;
    }
    input::-webkit-inner-spin-button,
    input::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }
    .remove-btn {
        background: #e74c3c;
        color: #fff;
        border: none;
        padding: 4px 10px;
        cursor: pointer;
        border-radius: 4px;
        transition: 0.2s;
    }
    .remove-btn:hover {
        background: #c0392b;
    }
    h3 {
        text-align: center;
        color: #333;
    }
    #grand-total {
        color: #007bff;
        font-weight: bold;
    }
</style>
</head>

<h2>سبد خرید شما</h2>

{% if is_item %}
    <table>
    <thead>
        <tr>
            <th>تصویر محصول</th>
            <th>نام محصول</th>
            <th>قیمت واحد (تومان)</th>
            <th>تعداد</th>
            <th>مجموع</th>
            <th>حذف</th>
        </tr>
    </thead>
    <tbody id="cart-body">
    {% for item in items %}
        <tr data-id="1" data-price="item.product.price">
            <td>
                <a href="{% url 'product_detail' category_slug=item.product.category.parent.slug subcategory_slug=item.product.category.slug pk=item.product.pk %}">
                    <figure>
                        {% thumbnail item.product.image "50x50" crop="center" as im %}
                            <img src="{{ im.url }}">
                        {% endthumbnail %}
                    </figure>
                </a>
            </td>
            <td>{{ item.product.title }}</td>
            <td>
                {% if item.product.has_discount %}
                    <h6>
                        <span class="f-dark text-danger" style="text-decoration: line-through;">{{ item.product.price|price_format }} تومان</span>
                        <strong class="f-dark">{{ item.product.final_price|price_format }} تومان</strong>
                    </h6>
                {% else %}
                    <h6 class="f-dark"><strong>{{ item.product.price|price_format }} تومان</strong></h6>
              {% endif %}
            </td>
            <td>
                <div class="qty-wrapper">
                    <form method="post" action="{% url 'remove_to_item_cart' item.product.id %}">
                        {% csrf_token %}
                        <button class="qty-btn minus">-</button>
                    </form>
                    <input type="number" value="{{ item.quantity }}" min="1" class="qty-input" readonly>
                    <form method="post" action="{% url 'add_to_item_cart' item.product.id %}">
                        {% csrf_token %}
                        <button type="submit" class="qty-btn plus">+</button>
                    </form>
                </div>
            </td>
            <td>
                {% if item.product.has_discount %}
                    <h6 class="total-cell">
                         {{ item.quantity|mul:item.product.final_price|price_format }}
                    </h6>
                {% else %}
                    <h6 class="f-dark ">{{ item.quantity|mul:item.product.price|price_format }}</h6>
              {% endif %}
            </td>
            <td>
                <form method="post" action="{% url 'delete_item_card' item.product.id %}">
                    {% csrf_token %}
                    <button class="remove-btn">×</button>
                </form>
            </td>
        </tr>
    {% endfor %}
    </tbody>
</table>

    {% if has_discount_in_cart %}
        <span class="f-dark text-danger" style="text-decoration: line-through;">
            <h3><strong>جمع کل: <span id="grand-total">{{ total|price_format }}</span> تومان</strong></h3>
        </span>
        <br>
        <h3><strong>سود: <span id="grand-total">{{ total_profit|price_format }}</span> تومان</strong></h3>
        <br>
        <hr style="width: 50%; margin: 0 auto; border: 1px solid #000;">
        <br>
        <h3><strong>جمع کل با تخفیف: <span id="grand-total">{{ total_discount|price_format }}</span> تومان</strong></h3>
    {% else %}
            <h3><strong>جمع کل: <span id="grand-total">{{ total|price_format }}</span> تومان</strong></h3>
    {% endif %}

    <br>
    <a class="d-flex justify-content-center mb-5">
        <button type="submit" class="btn btn-success w-50">پرداخت</button>
    </a>
{% else %}
<div class="d-flex flex-column justify-content-center align-items-center text-center py-5">
    <img src="{% static 'img/cart.png' %}" alt="سبد خرید خالی است"
         class="img-fluid mb-4" style="max-width: 250px;">
    <h4 class="text-muted">سبد خرید خالی است</h4>
</div>
{% endif %}

{% endblock %}